{# Choose base on which to extend this template #}
{% extends "base.twig" %}

{# Import macros for use in this template #}
{% import "mixins.twig" as mixin %}

{# Set lesson number #}
{% set lesson_number=0 %}
{% set lesson_complete = false %}
{% for lesson in sub_unit_meta.unit_lessons %}

    {% if lesson.ID == quiz_lesson.ID %}
        {% set lesson_number=loop.index %}
        {% if lesson.complete %}
            {% set lesson_complete = true %}
        {% endif %}
    {% endif %}

{% endfor %}

{# Twig block to be included in Base.twig #}
{% block content %}
    <div class="wrapper single-lesson-wrapper" id="page-wrapper" xmlns="http://www.w3.org/1999/html">

        {# Include mobile progress component #}
        {% include '/lms/embeds/lesson-progress-mobile.twig' %}
        {# Include desktop progress component #}
        {% include '/lms/embeds/lesson-sidebar.twig' %}
        {# Include lesson header component #}
        {% include '/lms/embeds/lesson-header.twig' %}


        {# If quiz outcome is set then show message and modal #}
        {%  if (quiz_retry or lesson_complete or quiz_resubmit)  %}
        <script>
            function animate(elem, style, unit, from, to, time, prop) {
                if (!elem) {
                    return;
                }
                var start = new Date().getTime(),
                    timer = setInterval(function () {
                        var step = Math.min(1, (new Date().getTime() - start) / time);
                        if (prop) {
                            elem[style] = (from + step * (to - from))+unit;
                        } else {
                            elem.style[style] = (from + step * (to - from))+unit;
                        }
                        if (step === 1) {
                            clearInterval(timer);
                        }
                    }, 25);
                if (prop) {
                    elem[style] = from+unit;
                } else {
                    elem.style[style] = from+unit;
                }
            }

            window.onload = function () {
                var target = document.getElementById("quiz-questions");
                animate(document.scrollingElement || document.documentElement, "scrollTop", "", 0, target.offsetTop -350, 1000, true);
            };
        </script>
         {# Set the quiz outcome message  #}
            <div class = "container quiz-message-container ">
                <div class="row flex-sm-column flex-md-row quiz-message-box {% if quiz_retry %}red-border{%  elseif lesson_complete %}green-border{% else %}primary-border{% endif %} mx-3 my-5 p-3">
                    <div class="col-auto d-none d-md-block">
                        {{source('/assets/lms/quiz_outcome.svg')}} 
                    </div>
                    {%  if quiz_retry %}

                        <div class="col-sm-12 col-md">
                            {{  attribute(options, lang.prefix~'quiz_outcome_retry_message')  }}
                        </div>
                        <div class="col-sm-12 col-md-auto d-flex flex-column">
                            <a   class="btn mx-3 mx-md-0 my-2 primary-btn-outline" href="{{fn('get_permalink',sub_unit_meta.unit_lessons[0].ID)}}" >
                               {{  attribute(options, lang.prefix~'quiz_review_button_text')  }}
                            </a>
                            <a id="quiz-reset"  class="fw-quiz-reset btn primary-btn-fill mx-3 mx-md-0" href="#" >
                                {{  attribute(options, lang.prefix~'quiz_retry_button_text')  }}
                            </a>
                        </div>

                    {% elseif lesson_complete %}
                        <div class="col">
                            {{  attribute(options, lang.prefix~'quiz_outcome_success_message')  }}
                        </div>
                    {% endif %}

                </div>
                <hr>
            </div>
        {% endif %}
        {%  if (quiz_retry or lesson_complete) and show_notifications %}

            {# Set the modal content depending on outcome #}
            {%  if quiz_retry %}
                {% set modal_content =  attribute(options, lang.prefix~'quiz_outcome_retry_content') %}
            {% elseif lesson_complete %}
                {% set modal_content =  attribute(options, lang.prefix~'quiz_outcome_success_content')  %}
            {% endif %}
            {# Set the modal ID to use to open the modal #}
            {% set modal_id = "quiz-message" %}
            {% embed "embeds/modals/modal-global.twig" %}
                {# Add quiz outcome header to modal #}
                {% block modal_header %}

                        <div class="col-auto">
                            {{source('/assets/lms/quiz_outcome.svg')}}
                        </div>
                        <div class="col-auto">
                           <h2>{{attribute(options, lang.prefix~'quiz_outcome_header')}}</h2>
                        </div>

                {% endblock %}
                {# Remove close button #}
                {% block modal_close %}
                
                {% endblock %}
                {# Add quiz modal content to modal #}
                {% block modal_body %}

                   <div class="col-12">
                       {{  modal_content }}
                   </div>

                {% endblock %}

            {% endembed %}
            {# Default the modal to open #}
            <script>
                jQuery(document).ready( function($) {
                    $('#{{ modal_id }}').modal('show');
                });
            </script>

           
        {% endif %}


        <!-- Lesson Content-->
        {% set lesson_post = quiz_lesson %}
        {% include '/lms/embeds/lesson-content.twig' %}
        <!-- Quiz Content-->
        <div id="quiz-questions" class = "container mt-5">
            <div class="row">
                <div class="col-12">
                {% do action('fundawande_single_quiz_content',post.id) %}

                </div>
            </div>
        </div>
        <!-- Bottom navigation-->
        <div class = "container pb-5">
            <div class="row my-0 justify-content-between">
                <div class="lesson-navigation-bottom col-12 col-md-auto text-center py-1 py-md-0">
                    {% if sub_unit_meta.nav.prev %}
                        <a href = "{{fn('get_permalink',sub_unit_meta.nav.prev)}}" class = "btn module-btn-outline-{{module_number}}"> <span class = "px-2">{{source ('/assets/arrow_left.svg')}}</span>{{attribute(options, lang.prefix~'prev_nav_text')}}</a>
                    {% endif %}
                </div>
                <div class=" lesson-navigation-bottom col-12 col-md-auto text-center py-1 py-md-0">
                    {% if quiz_retry %}
                        <a   class="btn mr-md-3 mr-0  module-btn-outline-{{sub_unit_meta.module_number}}" href="{{fn('get_permalink',sub_unit_meta.unit_lessons[0].ID)}}" >
                            {{  attribute(options, lang.prefix~'quiz_review_button_text')  }}
                        </a>
                        <a id="quiz-reset"  class=" fw-quiz-reset btn module-btn-fill-{{sub_unit_meta.module_number}}" href="#" >
                            {{  attribute(options, lang.prefix~'quiz_retry_button_text')  }}
                        </a>
                    {% endif %}
                    {% if quiz_resubmit and not quiz_retry and not lesson_complete %}
                        <a id="quiz-reset"  class=" fw-quiz-reset btn module-btn-outline-{{sub_unit_meta.module_number}}" href="#" >
                            {{  attribute(options, lang.prefix~'quiz_retry_button_text')  }}
                        </a>
                        <a id="lesson-next" href = "{{fn('get_permalink',sub_unit_meta.nav.next)}}" class = "btn module-btn-fill-{{sub_unit_meta.module_number}}" >{{attribute(options, lang.prefix~'next_nav_text')}} <span class = "p-2">{{source ('/assets/arrow_right.svg')}}</span></a>

                    {% endif %}
                    {% if lesson_complete %}
                        {% if sub_unit_meta.is_last_in_unit %}
                        
                            {% if show_notifications %}
                                {% include '/embeds/modals/modal-end-unit.twig' %}
                          
                            {# If a custom feedback message has been added for this lesson, fire a modal which displays the feedback before showing the end of unit modal #}
                            {% if post.get_field('custom_feedback_message') %}
                                {% include '/embeds/modals/modal-end-lesson.twig' %}
                                <button  type="button" class="btn module-btn-fill-{{sub_unit_meta.module_number}}" data-user-id="{{ user.ID }}" data-post-id="{{ post.ID }}" data-toggle="modal" data-target="#end-lesson-modal">
                                    {{attribute(options, lang.prefix~'complete_unit_text')}} <span class = "px-2">{{source ('/assets/arrow_right.svg')}}</span>
                                </button>
                                {% else %}
                                    <button type="button" class="btn module-btn-fill-{{sub_unit_meta.module_number}}" data-user-id="{{ user.ID }}" data-post-id="{{ post.ID }}" data-toggle="modal" data-target="#end-unit-modal">
                                        {{attribute(options, lang.prefix~'complete_unit_text')}} <span class = "px-2">{{source ('/assets/arrow_right.svg')}}</span>
                                    </button>
                                {% endif %}
                            {% else %}
                                <a id="lesson-next" href = "{{fn('get_permalink',sub_unit_meta.nav.next)}}" class = "btn module-btn-fill-{{sub_unit_meta.module_number}}" >{{attribute(options, lang.prefix~'next_nav_text')}} <span class = "p-2">{{source ('/assets/arrow_right.svg')}}</span></a>

                            {% endif %}
                        {% else %}
                            <a id="lesson-complete" href = "#" class = "btn module-btn-fill-{{sub_unit_meta.module_number}}" data-user-id="{{ user.ID }}" data-post-id="{{ post.ID }}" data-url="{{fn('get_permalink',sub_unit_meta.nav.next)}}">{{attribute(options, lang.prefix~'next_nav_text')}} <span class = "p-2">{{source ('/assets/arrow_right.svg')}}</span></a>
                        {% endif %}
                    {% elseif quiz_submitted %}
                   
                        <a  class="btn module-btn-fill-{{module_number}}" href="{{fn('get_permalink',sub_unit_meta.nav.next)}}" >
                            {{  attribute(options, lang.prefix~'next_nav_text')  }} <span class = "px-2">{{source ('/assets/arrow_right.svg')}}</span>
                        </a>
                    {% else %}
                        <a id="quiz-complete"  class="btn module-btn-fill-{{module_number}}" href="#" >
                            {{  attribute(options, lang.prefix~'quiz_submit_button_text')  }} <span class = "px-2">{{source ('/assets/arrow_right.svg')}}</span>
                        </a>
                    {% endif %}
                  
                </div>
            </div>
        </div>
    </div><!-- #wrapper -->

{% endblock %}